<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    
        <title>django之auth组件 | </title>
    

    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="format-detection" content="telephone=no">
<meta name="author" content="the3times" />
<meta name="designer" content="minfive" />
<meta name="keywords" content="null"/>
<meta name="description" content="" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=yes" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="robots" content="all" />

<link rel="canonical" href="http://yoursite.com/2020/07/05/django%E4%B9%8Bauth%E7%BB%84%E4%BB%B6/index.html">

<link rel="icon" type="image/png" href="undefined" sizes="32x32">














<!-- Prefetch -->






<!-- CSS -->

<link rel="stylesheet" href="/scss/base/index.css">


<!-- RSS -->
<link rel="alternate" href="/atom.xml" title="the3times的博客">

<!-- 统计 -->
<!-- 百度统计 -->


<!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    
<link rel="stylesheet" href="/scss/views/page/post.css">


<meta name="generator" content="Hexo 4.2.1"></head>
<body ontouchstart>
    
        <!-- loading 页面 -->
<div id="page-loading" class="page page-loading" style="background-image: url('undefined')"></div>
    

    <div id="page" class="page js-hidden">
        
    <!-- 页头 -->
<header class="page__small-header page__header--small">
    <nav class="page__navbar">
        <div class="page__container navbar-container">
            <a class="page__logo" href="/" title="the3times的博客" alt="the3times的博客">
                <img src="undefined" alt="the3times的博客">
            </a>

            <nav class="page__nav">
                <ul class="nav__list clearfix">
                    
                        
                        <li class="nav__item">
                            <a href="/" alt="首页" title="首页">首页</a>
                        </li>
                    
                        
                        <li class="nav__item">
                            <a href="/archives" alt="归档" title="归档">归档</a>
                        </li>
                    
                        
                        <li class="nav__item">
                            <a href="/about" alt="关于" title="关于">关于</a>
                        </li>
                    
                </ul>
            </nav>

            <button class="page__menu-btn" type="button">
                <i class="iconfont icon-menu"></i>
            </button>
        </div>
    </nav>
</header>


        
    <main class="page__container page__main">
    <div class="page__content">
        <article class="page__post">
    <div class="post__cover">
        <img src="undefined" alt="django之auth组件">
    </div>

    <header class="post__info">
        <h1 class="post__title">django之auth组件</h1>

        <div class="post__mark">
            <div class="mark__block">
                <i class="mark__icon iconfont icon-write"></i>
                <ul class="mark__list clearfix">
                    
                        <li class="mark__item">
                            <a href="/">undefined</a>
                        </li>
                    
                </ul>
            </div>
            
            <div class="mark__block">
                <i class="mark__icon iconfont icon-time"></i>
                <ul class="mark__list clearfix">
                    <li class="mark__item"><span>2020-07-05</span></li>
                </ul>
            </div>

            <div class="mark__block">
                <i class="mark__icon iconfont icon-tab"></i>
                <ul class="mark__list clearfix">
                    
                </ul>
            </div>

            
        </div>
    </header>

    <div class="post__content">
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>django提供了一个非常好用的组件，这个组件主要负责用户登录认证的全套功能，它就是auth组件。</p>
<p>有了auth组件，我们就不需要再手动写登录校验装饰器，不需要再手动设置session保存用户状态。</p>
<p>django项目执行数据库迁移命令后会生成一堆默认的表，其中就包括auth_user表，auth组件和这张表有密切关系。</p>
<p>另外，django项目默认都会有一个admin后台管理系统，登录的用户信息是保存在auth_user表中的；且用户分为普通用户和超级用户，只有超级用户可以登录admin后台管理系统。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行方式创建一个超级用户</span></span><br><span class="line">python3 manage.py createsuperuser</span><br></pre></td></tr></table></figure>

<h2 id="auth模块基本使用"><a href="#auth模块基本使用" class="headerlink" title="auth模块基本使用"></a>auth模块基本使用</h2><h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><p><strong>登录校验</strong>：<code>auth.authenticate()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">user_obj = auth.authenticate(request,</span><br><span class="line">                             username=username,</span><br><span class="line">                             password=password)</span><br><span class="line"></span><br><span class="line">print(user_obj) </span><br><span class="line">print(user_obj.username)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意点：</span></span><br><span class="line">    <span class="number">1.</span>authenticate()括号内必须同时传入用户名和密码</span><br><span class="line">    <span class="number">2.</span>密码自动加密校验</span><br><span class="line">    <span class="number">3.</span>校验成功，返回当前对象，校验失败返回<span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p><strong>保存用户状态</strong>：<code>auth.login()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">auth.login(request, user_obj)  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意点：</span></span><br><span class="line">    <span class="number">1.</span>该方法需要request、和当前登陆用户对象俩个方法</span><br><span class="line">    <span class="number">2.</span>该方法自动设置session，类似于request.session[key] = user_obj</span><br><span class="line">    <span class="number">3.</span>只要执行了该方法后，就可以在任何地方通过request.user获取到当前登陆的用户对象</span><br></pre></td></tr></table></figure>

<p><strong>获取当前登陆用户对象</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.user</span><br></pre></td></tr></table></figure>

<p><strong>判断当前用户是否登陆</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.user.is_authenticated               <span class="comment">#补充：is_authenticated其实是方法，只不过被property装饰了可以当属性用</span></span><br></pre></td></tr></table></figure>

<p><strong>登录装饰器</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required(login_url='/login/') </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意点：</span></span><br><span class="line">    <span class="number">1.</span>未登录时跳转到的页面需要手动设置；设置分局部设置和全局设置。</span><br><span class="line">    <span class="number">2.</span>局部设置，直接在装饰器内通过参数login_url指定</span><br><span class="line">    <span class="number">3.</span>全局设置，在配置文件中通过参数LOGIN_URL = <span class="string">'/login/'</span>设置</span><br><span class="line">    <span class="number">4.</span>装饰器帮我们在跳转后的url后面添加了target_url，我们在login的视图函数中手动捕获它</span><br><span class="line">    <span class="number">4.</span>局部设置的优先级高与全局的设置</span><br><span class="line">    <span class="comment">#5.全局的好处在于无需重复写代码 但是跳转的页面却很单一</span></span><br><span class="line">    <span class="comment">#6.局部的好处在于不同的视图函数在用户没有登陆的情况下可以跳转到不同的页面</span></span><br></pre></td></tr></table></figure>

<p><strong>校验密码是否正确</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.user.check_password(old_password)</span><br></pre></td></tr></table></figure>

<p><strong>修改密码</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.user.set_password(new_password)</span><br><span class="line">request.user.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意点：</span></span><br><span class="line">    需要两个，第一步仅仅是在修改对象的属性；第二步才是真正的操作数据库</span><br></pre></td></tr></table></figure>

<p><strong>注销</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth.logout(request) 		<span class="comment"># 相等于 request.session.flush()</span></span><br></pre></td></tr></table></figure>

<p><strong>注册</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：操作auth_user表写入数据(不推荐，密码没有加密处理)</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line">User.objects.create(username=username, password=password) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2：创建普通用户</span></span><br><span class="line">User.objects.create_user(username=username, password=password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式3：创建超级用户</span></span><br><span class="line">User.objects.create_superuser(username=username,</span><br><span class="line">                              email=<span class="string">'123@qq.com'</span>,</span><br><span class="line">                              password=password)</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：</span></span><br><span class="line">	<span class="number">1.</span>方式<span class="number">2</span>和方式<span class="number">3</span>创建成功后返回当前对象</span><br><span class="line">	<span class="number">2.</span>使用代码创建超级用户，邮箱是必填的，而用命令创建则可以不填</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">auth.authenticate()			<span class="comment"># 校验登录用户用户名和密码</span></span><br><span class="line">auth.login(request, user_obj) 		<span class="comment"># 登陆后保存登录状态</span></span><br><span class="line">auth.logout(request)			<span class="comment"># 注销</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存登录状态后，可以在任何位置通过request.user获取到当前登陆的用户对象</span></span><br><span class="line"><span class="comment"># 获取当前对象后，可以通过点的方式获取对象属性和方法</span></span><br><span class="line"></span><br><span class="line">request.user.is_authenticated()		<span class="comment"># 判断对象是否登录（is_authenticated其实是方法，只不过被property装饰了也可以当属性用）</span></span><br><span class="line">request.user.check_password()		<span class="comment"># 查看用户密码是否正确</span></span><br><span class="line"></span><br><span class="line">request.user.set_password()			<span class="comment"># 设置密码(更新密码)</span></span><br><span class="line">request.user.save()				<span class="comment"># 设置密码一定要save后才有效</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他方法</span></span><br><span class="line">User.objects.create_user()			<span class="comment"># 创建普通用户</span></span><br><span class="line">login_required					<span class="comment"># 登录校验装饰器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 总结：使用auth就使用全套的</span></span><br><span class="line">    优点：封装了大量的内置方法，使用方便</span><br><span class="line">    缺点：耦合程度高，只能全套使用，灵活性差</span><br></pre></td></tr></table></figure>

<h2 id="扩展auth-user表"><a href="#扩展auth-user表" class="headerlink" title="扩展auth_user表"></a>扩展auth_user表</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需求：</span></span><br><span class="line">使用auth组件的功能，同时又需要额外新增一些其他新字段</span><br></pre></td></tr></table></figure>

<h3 id="解决方式1-不推荐"><a href="#解决方式1-不推荐" class="headerlink" title="解决方式1(不推荐)"></a><strong>解决方式1(不推荐)</strong></h3><p>利用表和表的外键约束关系，新建一张用户表和<code>auth_user</code>表一对一外键关联。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDetail</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">     phone = models.BigIntegerField()</span><br><span class="line">     user = models.OneToOneField(to=<span class="string">'User'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="解决方式2-推荐"><a href="#解决方式2-推荐" class="headerlink" title="解决方式2(推荐)"></a><strong>解决方式2(推荐)</strong></h3><p>利用类的继承关系，定义一个新类继承<code>AbstractUser</code>，再增加几个新属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    phone = models.BigIntegerField()</span><br></pre></td></tr></table></figure>

<p><strong>方式2的好处</strong></p>
<ul>
<li>自己写一个继承了<code>AbstractUser</code>的表<code>UserInfo</code>，执行数据库数据库迁移命令的时候<code>auth_user</code>表就不会再创建出来了</li>
<li>而<code>UserInfo</code>表中会出现<code>auth_user</code>所有的字段外加自己扩展的字段</li>
<li>这么做的好处在于你能够直接点击你自己的表更加快速的完成操作及扩展</li>
<li>自己写表<code>UserInfo</code>替代了<code>auth_user</code>，那么<code>auth</code>模块的功能还是照常使用，参考的表页由原来的<code>auth_user</code>变成了<code>UserInfo</code></li>
</ul>
<p><strong>方式2的前提</strong></p>
<ul>
<li><p>在继承之前没有执行过数据库迁移命令；即如果已经有了<code>auth_user</code>表则无法再使用该方式。</p>
</li>
<li><p>继承的类里面不要覆盖<code>AbstractUser</code>里面的字段名；表里面有的字段都不要动，只扩展额外字段即可。</p>
</li>
<li><p>需要在配置文件中告诉django你要用<code>UserInfo</code>替代<code>auth_user</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置方式</span></span><br><span class="line">AUTH_USER_MODEL = <span class="string">'app01.UserInfo'</span>		<span class="comment"># '应用名.表名'</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><img src="https://img2020.cnblogs.com/blog/1950650/202006/1950650-20200609165606309-967936755.jpg" alt=""></p>


        
        <div class="post-announce">
            感谢您的阅读，本文由
            <a href="http://yoursite.com">the3times的博客</a>
            版权所有。如若转载，请注明出处：the3times的博客（<a href="http://yoursite.com/2020/07/05/django%E4%B9%8Bauth%E7%BB%84%E4%BB%B6/">http://yoursite.com/2020/07/05/django%E4%B9%8Bauth%E7%BB%84%E4%BB%B6/</a>）
        </div>
        

        <div class="post__prevs">
            <div class="post__prev">
                
                <a href="/2020/07/05/hello-world/" title="Hello World"><i class="iconfont icon-prev"></i>Hello World</a>
                
            </div>
            <div class="post__prev post__prev--right">
                
                <a href="/2020/07/05/django%E4%B9%8Bforms%E7%BB%84%E4%BB%B6/" title="django之forms组件">django之forms组件<i class="iconfont icon-next"></i></a>
                
            </div>
        </div>
    </div>
</article>

        
        
    </div>

    <aside class="page__sidebar">
    <!--  -->

    <form id="page-search-from" class="page__search-from" action="/search/">
        <label class="search-form__item">
            <input class="input" type="text" name="search" placeholder="Search...">
            <i class="iconfont icon-search"></i>
        </label>
    </form>

    

    <div class="sidebar__block">
        <h3 class="block__title">文章分类</h3>
        
    </div>
    
    <div class="sidebar__block">
        <h3 class="block__title">最新文章</h3>
        
        <ul class="block-list latest-post-list">
            
                    <li class="latest-post-item">
                        <a href="/2020/07/05/django%E4%B9%8Bforms%E7%BB%84%E4%BB%B6/" title="django之forms组件">
                            <div class="item__cover">
                                <img src="undefined" alt="django之forms组件" />
                            </div>
                            <div class="item__info">
                                <h3 class="item__title">django之forms组件</h3>
                                <span class="item__text">2020-07-05</span>
                            </div>
                        </a>
                    </li>
                
                    <li class="latest-post-item">
                        <a href="/2020/07/05/django%E4%B9%8Bauth%E7%BB%84%E4%BB%B6/" title="django之auth组件">
                            <div class="item__cover">
                                <img src="undefined" alt="django之auth组件" />
                            </div>
                            <div class="item__info">
                                <h3 class="item__title">django之auth组件</h3>
                                <span class="item__text">2020-07-05</span>
                            </div>
                        </a>
                    </li>
                
                    <li class="latest-post-item">
                        <a href="/2020/07/05/hello-world/" title="Hello World">
                            <div class="item__cover">
                                <img src="undefined" alt="Hello World" />
                            </div>
                            <div class="item__info">
                                <h3 class="item__title">Hello World</h3>
                                <span class="item__text">2020-07-05</span>
                            </div>
                        </a>
                    </li>
                
        </ul>
    
    </div>

    <div class="sidebar__block">
        <h3 class="block__title">文章标签</h3>
        
        <ul class="block-list tag-list clearfix">
            
        </ul>
    
    </div>

    <!-- <div class="sidebar__block">
        <h3 class="block__title">友情链接</h3>
        <ul class="block-list">
            
        </ul>
    </div> -->
</aside>
</main>


        
            <!-- 页脚 -->
<footer class="page__footer">
    <section class="footer__top">
        <div class="page__container footer__container">
            
            <div class="footer-top__item footer-top__item--2">
                <h3 class="item__title">关于</h3>
                <div class="item__content">
                    <p class="item__text"></p>
                    <ul class="footer__contact-info">
                        <li class="contact-info__item">
                            <i class="iconfont icon-address"></i>
                            <span></span>
                        </li>
                        <li class="contact-info__item">
                            <i class="iconfont icon-email2"></i>
                            <span></span>
                        </li>
                    </ul>
                </div>
            </div>

            
            
            
            
            
        </div>
    </section>
    <section class="footer__bottom">
        <div class="page__container footer__container">
            <p class="footer__copyright">©
                <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by
                <a href="http://hexo.io/" target="_blank">Hexo</a>, made by 
                <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.
            </p>
            <ul class="footer__social-network clearfix">
                
            </ul>
        </div>
    </section>
</footer>
        

        
            <!-- 返回顶部 -->
<div id="back-top" class="back-top back-top--hidden js-hidden">
    <i class="iconfont icon-top"></i>
</div>
        
    </div>

    <!-- build:js /js/common.js -->
        <script type="text/javascript" src="js/common/utils.js"></script>
        <script type="text/javascript" src="js/common/pack.js"></script>
        <script type="text/javascript" src="js/common/animation.js"></script>
        <script type="text/javascript" src="js/layout/loading.js"></script>
        <script type="text/javascript" src="js/layout/header.js"></script>
        <script type="text/javascript" src="js/layout/back-top.js"></script>
        <script type="text/javascript" src="js/layout/post.js"></script>
    <!-- endbuild -->

    
    
<script src="/js/page/post.js"></script>



    
    



    <!-- 不蒜子统计 -->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>


     








</body>
</html>